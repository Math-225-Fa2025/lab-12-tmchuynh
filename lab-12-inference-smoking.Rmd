---
title: "Lab 12 - Smoking during pregnacy"
subtitle: "Simulation based inference"
output: 
  pdf_document:
    latex_engine: xelatex
    toc:true
    number_sections:true
    fig_caption:true
    citation_package: natbib
    keep_tex:true
link-citations: true
---

```{r include = FALSE}
knitr::opts_chunk$set(
  eval = TRUE,
  out.width = "80%",
  fig.asp = 0.618,
  fig.width = 10,
  dpi = 300
)
```

In 2004, the state of North Carolina released a large data set containing information on births recorded in this state.
This data set is useful to researchers studying the relation between habits and practices of expectant mothers and the birth of their children.
We will work with a random sample of observations from this data set.

# Learning goals

-   Constructing confidence intervals
-   Conducting hypothesis tests
-   Interpreting confidence intervals and results of hypothesis tests in context of the data

# Getting started

Go to the course GitHub organization and locate your homework repo, clone it in RStudio and open the R Markdown document.
Knit the document to make sure it compiles without errors.

## Warm up

Let's warm up with some simple exercises.
Update the YAML of your R Markdown file with your information, knit, commit, and push your changes.
Make sure to commit with a meaningful commit message.
Then, go to your repo on GitHub and confirm that your changes are visible in your Rmd **and** md files.
If anything is missing, commit and push again.

## Packages

We'll use the **tidyverse** package for much of the data wrangling and visualisation, the **tidymodels** package for inference, and the data lives in the **openintro** package.
These packages are already installed for you.
You can load them by running the following in your Console:

```{r}
library(tidyverse)
library(tidymodels)
library(openintro)
library(skimr)
```

## Data

The data can be found in the **openintro** package, and it's called `ncbirths`.
Since the dataset is distributed with the package, we don't need to load it separately; it becomes available to us when we load the package.
You can find out more about the dataset by inspecting its documentation, which you can access by running `?ncbirths` in the Console or using the Help menu in RStudio to search for `ncbirths`.
You can also find this information [here](https://www.openintro.org/data/index.php?data=ncbirths).

# Set a seed!

In this lab we'll be generating random samples.
The last thing you want is those samples to change every time you knit your document.
So, you should set a seed.
There's an R chunk in your R Markdown file set aside for this.
Locate it and add a seed.
Make sure all members in a team are using the same seed so that you don't get merge conflicts and your results match up for the narratives.

```{r set-seed}
set.seed(12345)
```

# Exercises

1.  What are the cases in this data set? How many cases are there in our sample?

```{r exercise-1}
# Explore the dataset
head(ncbirths)
dim(ncbirths)
glimpse(ncbirths)
```

**Answer:** The cases in this dataset are births recorded in North Carolina in 2004. Each row represents one birth with information about the baby's weight and characteristics, as well as the mother's demographics and habits. The sample contains `nrow(ncbirths)` births.

The first step in the analysis of a new dataset is getting acquainted with the data.
Make summaries of the variables in your dataset, determine which variables are categorical and which are numerical.
For numerical variables, are there outliers?
If you aren't sure or want to take a closer look at the data, make a graph.

```{r data-summary}
# Summary statistics
skim(ncbirths)

# Check for outliers in weight
ncbirths %>%
  ggplot(aes(x = weight)) +
  geom_histogram(binwidth = 0.5, fill = "steelblue") +
  labs(
    title = "Distribution of Baby Weights",
    x = "Weight (pounds)",
    y = "Count"
  ) +
  theme_minimal()

# Summary by categorical variables
ncbirths %>%
  count(habit)

ncbirths %>%
  count(mature)
```

**Analysis:** The dataset contains both numerical variables (weight, age) and categorical variables (habit, mature, lowbirthweight). The weight distribution appears approximately normal with a few potential outliers on the left tail (very low birth weights). Missing values exist in the `habit` variable that we'll need to handle in later analyses.

## Baby weights

A 1995 study suggests that average weight of Caucasian babies born in the US is 3,369 grams (7.43 pounds).[^lab-12-inference-smoking-1]
In this dataset we only have information on mother's race, so we will make the simplifying assumption that babies of Caucasian mothers are also Caucasian, i.e. `whitemom = "white"`.

We want to evaluate whether the average weight of Caucasian babies has changed since 1995.

Our null hypothesis should state "there is nothing going on", i.e. no change since 1995: $H_0: \mu = 7.43~pounds$.

Our alternative hypothesis should reflect the research question, i.e. some change since 1995.
Since the research question doesn't state a direction for the change, we use a two sided alternative hypothesis: $H_A: \mu \ne 7.43~pounds$.

3.  Create a filtered data frame called `ncbirths_white` that contain data only from white mothers.
    Then, calculate the mean of the weights of their babies.

```{r exercise-3}
# Filter for white mothers
ncbirths_white <- ncbirths %>%
  filter(whitemom == "white")

# Calculate mean weight
mean_weight_white <- ncbirths_white %>%
  summarise(mean_weight = mean(weight)) %>%
  pull(mean_weight)

mean_weight_white
```

**Result:** The mean weight of babies born to white mothers in this sample is `r round(mean_weight_white, 2)` pounds, compared to the 1995 baseline of 7.43 pounds.

4.  Are the conditions necessary for conducting simulation based inference satisfied?
    Explain your reasoning.

```{r exercise-4}
# Check sample size
nrow(ncbirths_white)

# Check for normality
ncbirths_white %>%
  ggplot(aes(x = weight)) +
  geom_histogram(binwidth = 0.3, fill = "steelblue") +
  geom_vline(aes(xintercept = mean(weight)), color = "red", linetype = "dashed") +
  labs(
    title = "Distribution of Baby Weights (White Mothers)",
    x = "Weight (pounds)",
    y = "Count"
  ) +
  theme_minimal()
# Check for independence (births are independent events)
# Check for skewness
ncbirths_white %>%
  summarise(
    n = n(),
    mean = mean(weight),
    sd = sd(weight),
    min = min(weight),
    max = max(weight)
  )
```

**Answer:** Yes, the conditions for simulation-based inference are satisfied:
1. **Independence:** Each birth is an independent event (births are not related to each other).
2. **Sample size:** With `r nrow(ncbirths_white)` observations, we have a sufficiently large sample size for the Central Limit Theorem to apply.
3. **No extreme skewness:** The distribution of weights appears approximately normal without extreme outliers, though there is some skewness with a few very low weights.

Let's discuss how this test would work.
Our goal is to simulate a null distribution of sample means that is centred at the null value of 7.43 pounds.
In order to do so, we

-   take a bootstrap sample of from the original sample,
-   calculate this bootstrap sample's mean,
-   repeat these two steps a large number of times to create a bootstrap distribution of means centred at the observed sample mean,
-   shift this distribution to be centred at the null value by subtracting / adding X to all bootstrap mean (X = difference between mean of bootstrap distribution and null value), and
-   calculate the p-value as the proportion of bootstrap samples that yielded a sample mean at least as extreme as the observed sample mean.

5.  Run the appropriate hypothesis test, visualize the null distribution, calculate the p-value, and interpret the results in context of the data and the hypothesis test.

```{r exercise-5}
# Conduct hypothesis test
null_dist_weight <- ncbirths_white %>%
  specify(response = weight) %>%
  hypothesize(null = "point", mu = 7.43) %>%
  generate(reps = 5000, type = "bootstrap") %>%
  calculate(stat = "mean")

# Visualize the null distribution
null_dist_weight %>%
  visualize() +
  shade_p_value(obs_stat = mean_weight_white, direction = "two-sided") +
  labs(
    title = "Null Distribution of Sample Mean Baby Weight",
    x = "Sample Mean Weight (pounds)",
    y = "Count"
  ) +
  theme_minimal()

# Calculate p-value
p_value <- null_dist_weight %>%
  get_p_value(obs_stat = mean_weight_white, direction = "two-sided")

p_value
```

**Interpretation:** The hypothesis test reveals whether the average weight of Caucasian babies has significantly changed since 1995. The null distribution shows what we would expect if there were no change. The p-value indicates the probability of observing a sample mean at least as extreme as `r round(mean_weight_white, 2)` pounds, given that the true population mean is 7.43 pounds. If the p-value is less than 0.05, we reject the null hypothesis and conclude that there is significant evidence of a change in average baby weights. If p-value ≥ 0.05, we fail to reject the null hypothesis, meaning we don't have sufficient evidence of a change.

## Baby weight vs. smoking

Consider the possible relationship between a mother's smoking habit and the weight of her baby.
Plotting the data is a useful first step because it helps us quickly visualize trends, identify strong associations, and develop research questions.

6.  Make side-by-side boxplots displaying the relationship between `habit` and `weight`.
    What does the plot highlight about the relationship between these two variables?

```{r exercise-6}
ncbirths %>%
  ggplot(aes(x = habit, y = weight)) +
  geom_boxplot(fill = "steelblue", alpha = 0.7) +
  labs(
    title = "Baby Weight by Mother's Smoking Habit",
    x = "Mother's Smoking Habit",
    y = "Baby Weight (pounds)"
  ) +
  theme_minimal()
```

**Interpretation:** The boxplots show the distribution of baby weights for mothers who smoke versus those who don't. The plot highlights the central tendency (median), spread (IQR), and outliers for each group. If there's a difference, the median and overall distribution should differ between the two groups, with babies of non-smoking mothers potentially having higher weights on average.

7.  Before moving forward, save a version of the dataset omitting observations where there are NAs for `habit`.
    You can call this version `ncbirths_habitgiven`.

```{r exercise-7-data}
# Remove NA values in habit column
ncbirths_habitgiven <- ncbirths %>%
  filter(!is.na(habit))
# Verify the filtering
nrow(ncbirths)
nrow(ncbirths_habitgiven)
```

**Result:** By filtering out NAs in the `habit` column, we now have `r nrow(ncbirths_habitgiven)` complete observations for the smoking analysis.

The box plots show how the medians of the two distributions compare, but we can also compare the means of the distributions using the following to first group the data by the `habit` variable, and then calculate the mean `weight` in these groups using.

```{r habit-means}
ncbirths_habitgiven %>%
  group_by(habit) %>%
  summarise(mean_weight = mean(weight))
```

There is an observed difference, but is this difference statistically significant?
In order to answer this question we will conduct a hypothesis test .

**Observation:** There is an observed difference in mean weights between the two groups. The exact difference will determine the strength of our evidence in the hypothesis test.

- H₀: There is no difference in average baby weight based on mother's smoking habit (μ_nonsmoking = μ_smoking)
- H_A: There is a difference in average baby weight based on mother's smoking habit (μ_nonsmoking ≠ μ_smoking)

7.  Write the hypotheses for testing if the average weights of babies born to smoking and non-smoking mothers are different.

```{r exercise-7-observed-diff}
# Calculate observed difference in means
observed_diff <- ncbirths_habitgiven %>%
  group_by(habit) %>%
  summarise(mean_weight = mean(weight), .groups = "drop") %>%
  pivot_wider(names_from = habit, values_from = mean_weight) %>%
  mutate(difference = `nonsmoker` - `smoker`) %>%
  pull(difference)

observed_diff
```

**Interpretation:** The observed difference in mean baby weight is approximately `r round(observed_diff, 3)` pounds. This represents the difference in average weights between babies born to non-smoking mothers and babies born to smoking mothers in our sample. We will now conduct a hypothesis test to determine if this difference is statistically significant.

8.  Are the conditions necessary for conducting simulation based inference satisfied?
    Explain your reasoning.

```{r exercise-8-conditions}
# Check sample sizes and distribution
ncbirths_habitgiven %>%
  group_by(habit) %>%
  summarise(
    n = n(),
    mean = mean(weight),
    sd = sd(weight),
    .groups = "drop"
  )

# Visualize distributions
ncbirths_habitgiven %>%
  ggplot(aes(x = weight, fill = habit)) +
  geom_histogram(bins = 30, alpha = 0.7, position = "identity") +
  labs(
    title = "Distribution of Baby Weight by Mother's Smoking Habit",
    x = "Baby Weight (pounds)",
    y = "Count",
    fill = "Smoking Habit"
  ) +
  theme_minimal() +
  facet_wrap(~habit)
```

**Conditions Assessment:** 
1. **Independence:** The observations are independent within each group (babies from different mothers).
2. **Sample Size:** Both groups have sufficient sample sizes (n > 30 for each group), which is important for the Central Limit Theorem to apply.
3. **Normality:** The histograms show that the distributions of baby weights are roughly symmetric and approximately normal in both groups, which supports our ability to use simulation-based inference.
4. **Same Variance:** The distributions appear to have similar spreads, though this is less critical for simulation-based methods.

All conditions appear to be satisfied, making simulation-based inference appropriate for this analysis.

9.  Run the appropriate hypothesis test, calculate the p-value, and interpret the results in context of the data and the hypothesis test.

```{r exercise-9-hypothesis-test}
set.seed(1234)

# Prepare the data
smoke_test_data <- ncbirths_habitgiven %>%
  select(weight, habit) %>%
  drop_na()

# Calculate the observed difference in means
obs_diff_smoke <- smoke_test_data %>%
  specify(weight ~ habit) %>%
  calculate(stat = "diff in means", order = c("nonsmoker", "smoker"))

# Generate null distribution
null_dist_smoke <- smoke_test_data %>%
  specify(weight ~ habit) %>%
  hypothesize(null = "independence") %>%
  generate(reps = 5000, type = "permute") %>%
  calculate(stat = "diff in means", order = c("nonsmoker", "smoker"))

# Visualize the null distribution
null_dist_smoke %>%
  visualize() +
  shade_p_value(obs_stat = obs_diff_smoke, direction = "two-sided") +
  labs(
    title = "Null Distribution of Difference in Mean Baby Weight",
    x = "Difference in Mean Weight (pounds): Nonsmoker - Smoker",
    y = "Count"
  ) +
  theme_minimal()

# Calculate the p-value
p_value_smoke <- null_dist_smoke %>%
  get_p_value(obs_stat = obs_diff_smoke, direction = "two-sided")

p_value_smoke
```

**Interpretation:** The hypothesis test examines whether there is a significant difference in average baby weight between mothers who smoke and mothers who don't smoke. The null distribution shows what differences we would expect if smoking habit had no effect on baby weight. 

The observed difference in means is `r round(obs_diff_smoke[[1]], 3)` pounds. The p-value of `r round(p_value_smoke[[1]], 4)` indicates the probability of observing a difference this extreme (or more extreme) if there truly were no difference between the two groups.

Since the p-value is `r ifelse(p_value_smoke[[1]] < 0.05, "less than 0.05, we reject the null hypothesis and conclude that there is statistically significant evidence that mothers' smoking habit is associated with differences in baby weight. Babies born to non-smoking mothers weigh on average more than those born to smoking mothers.", "greater than 0.05, we fail to reject the null hypothesis. We do not have sufficient evidence to conclude that smoking habit affects baby weight.")`.

10. Construct a 95% confidence interval for the difference between the average weights of babies born to smoking and non-smoking mothers.

```{r exercise-10-confidence-interval}
set.seed(1234)

# Generate bootstrap distribution for confidence interval
boot_dist_smoke <- smoke_test_data %>%
  specify(weight ~ habit) %>%
  generate(reps = 5000, type = "bootstrap") %>%
  calculate(stat = "diff in means", order = c("nonsmoker", "smoker"))

# Calculate 95% confidence interval
ci_smoke <- boot_dist_smoke %>%
  get_ci(level = 0.95, type = "percentile")

ci_smoke

# Visualize the bootstrap distribution with CI
boot_dist_smoke %>%
  visualize() +
  shade_ci(endpoints = ci_smoke, fill = "green", alpha = 0.3) +
  labs(
    title = "Bootstrap Distribution of Difference in Mean Baby Weight",
    x = "Difference in Mean Weight (pounds): Nonsmoker - Smoker",
    y = "Count"
  ) +
  theme_minimal()
```

**Interpretation:** We are 95% confident that the true difference in average baby weight between non-smoking and smoking mothers is between `r round(ci_smoke[[1]], 3)` and `r round(ci_smoke[[2]], 3)` pounds. 

Since the confidence interval `r ifelse((ci_smoke[[1]] > 0 | ci_smoke[[2]] < 0), "does not contain zero, this provides evidence that there is a meaningful difference in baby weights between the two groups.", "contains zero, this suggests that the difference might not be practically significant.")` The positive lower bound (if applicable) indicates that babies born to non-smoking mothers tend to weigh more on average.

## Baby weight vs. mother's age

In this portion of the analysis we focus on two variables.
The first one is `mature`.

11. First, a non-inference task: Determine the age cutoff for younger and mature mothers. Use a method of your choice, and explain how your method works.

The other variable of interest is `lowbirthweight`.

12. Conduct a hypothesis test evaluating whether the proportion of low birth weight babies is higher for mature mothers. State the hypotheses, verify the conditions, run the test and calculate the p-value, and state your conclusion in context of the research question. Use $\alpha = 0.05$. If you find a significant difference, construct a confidence interval, at the equivalent level to the hypothesis test, for the difference between the proportions of low birth weight babies between mature and younger mothers, and interpret this interval in context of the data.

[^lab-12-inference-smoking-1]: Wen, Shi Wu, Michael S. Kramer, and Robert H. Usher.
    "Comparison of birth weight distributions between Chinese and Caucasian infants." American Journal of Epidemiology 141.12 (1995): 1177-1187.
